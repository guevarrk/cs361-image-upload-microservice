<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Image Microservice — Test Page</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    body { margin: 24px; background:#fafbfc; color:#222; }
    h1 { margin: 0 0 12px; }
    .card { background:#fff; border:1px solid #e6e8ee; border-radius:14px; padding:16px; margin:12px 0; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    label { display:block; margin:8px 0; }
    input[type="text"] { padding:10px; border:1px solid #d5d8e0; border-radius:10px; width: 360px; max-width:100%; }
    input[type="file"] { padding:6px; }
    button { padding:10px 14px; border:1px solid #cfd3dc; border-radius:10px; background:#fff; cursor:pointer; }
    button.primary { background:#111; color:#fff; border-color:#111; }
    .muted { color:#666; font-size:0.95rem; }
    .thumb { max-width: 180px; border-radius: 10px; border:1px solid #e6e8ee; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:12px; }
    code { background:#f2f3f7; padding:2px 6px; border-radius:6px; }
  </style>
</head>
<body>
  <h1>Image Microservice — Demo Page</h1>
  <p class="muted">This page is served by the microservice. Upload an image, then list by <code>itemId</code>.</p>

  <div class="card">
    <h3>Health</h3>
    <div class="row">
      <button id="healthBtn">Check /health</button>
      <span id="healthStatus" class="muted"></span>
    </div>
  </div>

  <div class="card" style="display: none;">
    <h3>Settings</h3>
    <label>Item ID
      <input id="itemId" type="text" value="<%= defaultItemId %>">
    </label>
    <div class="row">
      <button id="listBtn">List by Item</button>
      <span id="listStatus" class="muted"></span>
    </div>
  </div>

  <div class="card">
    <h3>Upload</h3>
    <form id="uploadForm" action="/media/upload" method="post" enctype="multipart/form-data">
      <label>Photo
        <input name="photo" type="file" accept="image/*" required>
      </label>
      <input id="hiddenItemId" name="itemId" type="hidden" value="<%= defaultItemId %>">
      <label class="row" style="gap:10px;">
        <input name="enhance" type="checkbox" value="true"> Auto enhance
      </label>
      <div class="row">
        <button class="primary" type="submit">Upload</button>
        <span id="uploadStatus" class="muted"></span>
      </div>
    </form>
  </div>

  <div class="card">
    <h3>Item Media</h3>
    <div id="mediaGrid" class="grid"></div>
  </div>

<script>
const $ = id => document.getElementById(id);

async function checkHealth() {
  $('healthStatus').textContent = 'Checking...';
  try {
    const res = await fetch('/health');
    const data = await res.json();
    $('healthStatus').textContent = data.ok ? 'OK' : 'Unhealthy';
  } catch (e) {
    $('healthStatus').textContent = 'Failed: ' + e.message;
  }
}

async function listByItem() {
  const itemId = $('itemId').value.trim();
  $('hiddenItemId').value = itemId; // keep the form in sync
  $('listStatus').textContent = 'Loading...';
  try {
    const res = await fetch('/media/by-item/' + encodeURIComponent(itemId));
    const data = await res.json();
    $('listStatus').textContent = `Found ${data.count} file(s).`;
    renderMedia(data.media || []);
  } catch (e) {
    $('listStatus').textContent = 'Failed: ' + e.message;
  }
}

function renderMedia(media) {
  const grid = $('mediaGrid');
  grid.innerHTML = '';
  media.forEach(m => {
    const card = document.createElement('div');
    card.className = 'card';
    const img = document.createElement('img');
    img.src = `/media/${m.id}?variant=thumb`;
    img.alt = m.id;
    img.className = 'thumb';
    const p = document.createElement('p');
    p.className = 'muted';
    p.innerHTML = `<code>${m.id}</code> (${m.width || '?'}×${m.height || '?'})`;
    const row = document.createElement('div');
    row.className = 'row';
    const openMed = document.createElement('a');
    openMed.href = `/media/${m.id}?variant=medium`;
    openMed.target = '_blank';
    openMed.textContent = 'Open Medium';
    const openOrig = document.createElement('a');
    openOrig.href = `/media/${m.id}`;
    openOrig.target = '_blank';
    openOrig.textContent = 'Open Original';
    const del = document.createElement('button');
    del.textContent = 'Delete';
    del.onclick = async () => {
      if (!confirm('Delete this photo?')) return;
      await fetch(`/media/${m.id}`, { method: 'DELETE' });
      listByItem();
    };
    row.appendChild(openMed);
    row.appendChild(openOrig);
    row.appendChild(del);
    card.appendChild(img);
    card.appendChild(p);
    card.appendChild(row);
    grid.appendChild(card);
  });
}

$('healthBtn').addEventListener('click', checkHealth);
$('listBtn').addEventListener('click', listByItem);

// Intercept form submit so we can show status + refresh list
$('uploadForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const form = e.target;
  const itemId = $('itemId').value.trim();
  $('hiddenItemId').value = itemId;
  $('uploadStatus').textContent = 'Uploading...';

  try {
    const fd = new FormData(form);
    const res = await fetch('/media/upload', { method: 'POST', body: fd });
    const data = await res.json();
    if (!res.ok) {
      $('uploadStatus').textContent = (data && data.error) || 'Upload failed';
      return;
    }
    $('uploadStatus').textContent = 'Uploaded ✓';
    form.reset();
    $('hiddenItemId').value = itemId; // restore hidden after reset
    await listByItem();
  } catch (e) {
    $('uploadStatus').textContent = 'Upload failed: ' + e.message;
  }
});

// Auto-check health on load
checkHealth();
</script>
</body>
</html>
